<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-M">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>96-Hour Roadmap Checklist (Cloud-Sync)</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 3. Custom styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        
        /* Custom checkbox style */
        .task-checkbox {
            width: 1.15em;
            height: 1.15em;
            accent-color: #3b82f6; /* blue-500 */
        }

        /* Style for checked labels */
        input:checked + label,
        input:checked + label span {
            text-decoration: line-through;
            color: #6b7280; /* text-gray-500 */
        }

        /* Simple scrollbar for dark mode */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        /* Task item styling */
        .task-item {
            background-color: #1f2937; /* bg-gray-800 */
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .delete-button {
            background-color: #374151; /* bg-gray-700 */
            color: #d1d5db; /* text-gray-300 */
            border: none;
            border-radius: 0.375rem;
            padding: 0.25rem 0.625rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .delete-button:hover {
            background-color: #ef4444; /* red-500 */
            color: #ffffff;
        }

        /* Form styling */
        .form-input, .form-select, .form-textarea {
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4b5563; /* bg-gray-600 */
            color: #f3f4f6; /* text-gray-100 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: 2px solid #3b82f6; /* blue-500 */
            border-color: transparent;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-submit-button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
            width: 100%;
        }
        .form-submit-button:hover {
            background-color: #2563eb; /* blue-600 */
        }
        
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            color: white;
            font-size: 1.125rem;
        }
    </style>
</head>
<body class="text-gray-100 p-4 md:p-8">

    <!-- Loading overlay for migration -->
    <div id="loading-overlay" class="hidden">
        <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        <span id="loading-text">Loading tasks...</span>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">96-Hour Production Readiness Roadmap</h1>
            <p class="text-xl text-gray-400">Eye-Doo App - Cloud-Sync Checklist</p>
        </header>

        <!-- Progress Bar -->
        <section class="mb-8 bg-gray-800 p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-2">
                <span class="text-lg font-medium text-white">Overall Progress</span>
                <span id="progress-text" class="text-lg font-medium text-blue-300">0 / 0 tasks completed</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-4">
                <div id="progress-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </section>

        <!-- Add New Task Form -->
        <section class="mb-8 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-white mb-4">Add New Task</h2>
            <form id="add-task-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1">
                    <label for="task-title" class="form-label">Task Title</label>
                    <input type="text" id="task-title" class="form-input" placeholder="e.g., Fix auth bug" required>
                </div>
                <div class="md:col-span-2">
                    <label for="task-description" class="form-label">Description</label>
                    <input type="text" id="task-description" class="form-input" placeholder="e.g., `auth.ts` file is empty">
                </div>
                <div class="md:col-span-1">
                    <label for="task-priority" class="form-label">Priority</label>
                    <select id="task-priority" class="form-select">
                        <option value="critical">游댮 Critical Issue</option>
                        <option value="architectural">游리 Architectural Improvement</option>
                        <option value="feature">游릭 Missing Implementation</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex items-end">
                    <button type="submit" class="form-submit-button">Add Task</button>
                </div>
            </form>
        </section>


        <!-- Task Checklists -->
        <main id="checklist-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Column 1: Critical Bugs -->
            <section id="critical-section" class="bg-gray-800/50 p-6 rounded-lg shadow-lg min-h-[200px]">
                <h2 class="text-2xl font-semibold text-red-400 mb-4">游댮 Critical Issues</h2>
                <ul id="critical-list" class="space-y-4">
                    <!-- Tasks will be injected here by JavaScript -->
                </ul>
            </section>

            <!-- Column 2: Architectural Improvements -->
            <section id="architectural-section" class="bg-gray-800/50 p-6 rounded-lg shadow-lg min-h-[200px]">
                <h2 class="text-2xl font-semibold text-yellow-400 mb-4">游리 Architectural Improvements</h2>
                <ul id="architectural-list" class="space-y-4">
                    <!-- Tasks will be injected here by JavaScript -->
                </ul>
            </section>

            <!-- Column 3: Feature Completions -->
            <section id="feature-section" class="bg-gray-800/50 p-6 rounded-lg shadow-lg min-h-[200px]">
                <h2 class="text-2xl font-semibold text-green-400 mb-4">游릭 Missing Implementations</h2>
                <ul id="feature-list" class="space-y-4">
                    <!-- Tasks will be injected here by JavaScript -->
                </ul>
            </section>
        </main>
    </div>

    <!-- JavaScript for interactivity -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            updateDoc,
            writeBatch,
            getDocs,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration (PASTE YOURS HERE) ---
        
        // 1. Create a Firebase project at https://console.firebase.google.com/
        // 2. In your project, create a "Web App" (click the </> icon).
        // 3. Copy the 'firebaseConfig' object given to you and paste it below.
        
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // NOTE: This app uses a generic collection name, 'users/{userId}/tasks'.
        // You MUST set up your Firestore Security Rules to allow this.
        // Go to your new project -> Firestore Database -> Rules tab.
        // Paste these rules and "Publish":
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Allow signed-in users to read/write their own 'tasks'
            match /users/{userId}/tasks/{taskId} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }
          }
        }
        */

        // --- Global Variables ---
        let db, auth, userId, tasksCollectionRef;

        // --- DOM Elements ---
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const criticalList = document.getElementById('critical-list');
        const architecturalList = document.getElementById('architectural-list');
        const featureList = document.getElementById('feature-list');
        const addTaskForm = document.getElementById('add-task-form');
        const taskTitleInput = document.getElementById('task-title');
        const taskDescriptionInput = document.getElementById('task-description');
        const taskPriorityInput = document.getElementById('task-priority');
        const checklistContainer = document.getElementById('checklist-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // --- Static Data for One-Time Migration ---
        const staticTasks = [
            // 47 Critical Issues
            { title: "TimelineService Empty Implementation", description: "`src/services/timeline-service.ts` - Class is completely empty", priority: "critical", completed: false },
            { title: "AuthService Missing from ServiceFactory", description: "`src/services/ServiceFactory.ts` - Not registered in factory", priority: "critical", completed: false },
            { title: "TimelineService Missing Repository Injection", description: "`src/services/timeline-service.ts` - Constructor doesn't accept repository", priority: "critical", completed: false },
            { title: "LocationService Architecture Violation", description: "`src/services/location-service.ts:219` - Direct Firebase imports", priority: "critical", completed: false },
            { title: "BusinessCardService Incorrect QR Handling", description: "`src/services/business-card-service.ts:114` - `fetch(qrImageData)` where data is base64", priority: "critical", completed: false },
            { title: "BusinessCardService Type Casting", description: "`src/services/business-card-service.ts:174` - Unsafe cast", priority: "critical", completed: false },
            { title: "ProjectService Missing Deletion Logic", description: "`src/services/project-service.ts:231` - TODO comment, no authorization", priority: "critical", completed: false },
            { title: "ProjectService Incomplete Initialization", description: "`src/services/project-service.ts:93` - TODO for Timeline/Locations", priority: "critical", completed: false },
            { title: "PortalService Hardcoded Portal ID", description: "`src/services/portal-service.ts` - 'default-portal' hardcoded", priority: "critical", completed: false },
            { title: "ServiceFactory Missing AuthRepository", description: "`src/services/ServiceFactory.ts` - AuthRepository not in config", priority: "critical", completed: false },
            { title: "Auth Store Empty", description: "`src/stores/use-auth-store.ts` - File is completely empty", priority: "critical", completed: false },
            { title: "Missing Auth Persistence", description: "`src/config/firebaseConfig.ts:41` - Comment \"Need to add persistence\"", priority: "critical", completed: false },
            { title: "use-list-actions.ts Filename Mismatch", description: "File header says `useList.ts`", priority: "critical", completed: false },
            { title: "usePortal Hook Missing Auto-fetch", description: "`src/hooks/use-portal.ts:288` - Auto-fetch useEffect commented out", priority: "critical", completed: false },
            { title: "useBusinessCard Missing Loading State Updates", description: "`src/hooks/use-business-card.ts` - Loading state not updated", priority: "critical", completed: false },
            { title: "GlobalErrorHandler Filename Inconsistency", description: "File `error-handler-global-service.ts` vs class `GlobalErrorHandler`", priority: "critical", completed: false },
            { title: "ErrorMapper fromUnknown Returns Wrong Type", description: "`src/utils/error-mapper.ts:206` - Returns NetworkError for all unknown", priority: "critical", completed: false },
            { title: "ErrorMapper Missing Error Codes", description: "Some error codes not mapped in `createGenericError`", priority: "critical", completed: false },
            { title: "ErrorBoundary Missing Error Recovery", description: "`src/components/common/error-boundary.tsx` - No auto recovery", priority: "critical", completed: false },
            { title: "Toast Deduplication Window Too Short", description: "`src/services/error-handler-service.ts:21` - 5 seconds may be too short", priority: "critical", completed: false },
            { title: "Missing Error Context in Some Services", description: "Services don't pass full context to ErrorMapper", priority: "critical", completed: false },
            { title: "LoggingService Commented Out Sentry", description: "`src/services/logging-service.ts` - All Sentry code commented out", priority: "critical", completed: false },
            { title: "BusinessCardRepository uploadQRImage Not in Interface", description: "`...firestore-business-card-repository.ts:568` - Not in IBusinessCardRepository", priority: "critical", completed: false },
            { title: "BusinessCardService.getQRImageUrl Wrong Implementation", description: "`src/services/business-card-service.ts:204` - Calls `generateQRCode`", priority: "critical", completed: false },
            { title: "ITimelineRepository Has Commented Code", description: "`src/repositories/i-timeline-repository.ts:89-150` - Large commented block", priority: "critical", completed: false },
            { title: "Missing Repository Export", description: "`src/repositories/firestore/firestore-auth-repository.ts` - No export", priority: "critical", completed: false },
            { title: "List Repository Hardcoded Paths", description: "`src/repositories/firestore/list.repository.ts` - Paths not configurable", priority: "critical", completed: false },
            { title: "LocationService Direct Firebase Dependency", description: "`src/services/location-service.ts:25-26` - Importing `doc`, `collection`", priority: "critical", completed: false },
            { title: "PortalService Repository Method Signature Mismatch", description: "Repo methods expect different params than service calls", priority: "critical", completed: false },
            { title: "Missing Repository Validation", description: "Repos don't validate inputs before Firestore operations", priority: "critical", completed: false },
            { title: "Onboarding Schema Uses `z.any()`", description: "`src/domain/screens/onboarding.schema.ts:20` - Should have proper type", priority: "critical", completed: false },
            { title: "BusinessCardService Type Assertion", description: "`src/services/business-card-service.ts:174` - Unsafe type cast", priority: "critical", completed: false },
            { title: "Missing Type Exports", description: "Many domain types not exported from barrel files", priority: "critical", completed: false },
            { title: "Result Pattern Inconsistencies", description: "Some methods return different error types", priority: "critical", completed: false },
            { title: "use-list-actions.ts Missing Type Guards", description: "No runtime type checking in some places", priority: "critical", completed: false },
            { title: "ErrorMapper Type Narrowing Issues", description: "`fromUnknown` doesn't properly narrow types", priority: "critical", completed: false },
            { title: "ServiceFactory Config Optional Properties", description: "All repos optional but required at runtime", priority: "critical", completed: false },
            { title: "ProjectService Copy Operations Not Atomic", description: "`src/services/project-service.ts:78` - Uses Promise.all, not transaction", priority: "critical", completed: false },
            { title: "LocationService Geocoding Error Handling", description: "`src/services/location-service.ts:200` - Errors appended to notes", priority: "critical", completed: false },
            { title: "PortalService Cloud Function Error Mapping", description: "`src/services/portal-service.ts:71` - Uses `fromFirestore` for cloud errors", priority: "critical", completed: false },
            { title: "BusinessCardService QR Generation Returns Wrong Type", description: "`getQRImageUrl` should return URL string", priority: "critical", completed: false },
            { title: "ServiceFactory Lazy Loading Not Thread-Safe", description: "Race conditions possible", priority: "critical", completed: false },
            { title: "Firebase Config Missing Error Handling", description: "`src/config/firebaseConfig.ts` - No validation of config values", priority: "critical", completed: false },
            { title: "Environment Variables Not Validated", description: "No runtime checks for required env vars", priority: "critical", completed: false },
            { title: "Missing Production/Development Configs", description: "No environment-specific configurations", priority: "critical", completed: false },
            { title: "Hardcoded API Keys Path", description: "`src/services/location-service.ts:64` - `EXPO_PUBLIC_OPENCAGE_API_KEY`", priority: "critical", completed: false },
            { title: "Missing Feature Flag Implementation", description: "ServiceFactory has flags but they're not used", priority: "critical", completed: false },

            // 31 Architectural Improvements
            { title: "Standardize Result Pattern", description: "", priority: "architectural", completed: false },
            { title: "Consistent Error Handling", description: "", priority: "architectural", completed: false },
            { title: "Input Validation Everywhere", description: "", priority: "architectural", completed: false },
            { title: "Remove Commented Code", description: "", priority: "architectural", completed: false },
            { title: "Create Barrel Exports", description: "", priority: "architectural", completed: false },
            { title: "ServiceFactory Validation", description: "", priority: "architectural", completed: false },
            { title: "Extract Constants", description: "", priority: "architectural", completed: false },
            { title: "Implement Retry Logic", description: "", priority: "architectural", completed: false },
            { title: "Fix Subscription Cleanup", description: "", priority: "architectural", completed: false },
            { title: "Add Loading States", description: "", priority: "architectural", completed: false },
            { title: "Improve Type Safety", description: "", priority: "architectural", completed: false },
            { title: "Add JSDoc Comments", description: "", priority: "architectural", completed: false },
            { title: "Consistent Naming Conventions", description: "", priority: "architectural", completed: false },
            { title: "Remove Dead Code", description: "", priority: "architectural", completed: false },
            { title: "Fix ESLint Disables", description: "", priority: "architectural", completed: false },
            { title: "Add Input Sanitization", description: "", priority: "architectural", completed: false },
            { title: "Optimize ServiceFactory", description: "", priority: "architectural", completed: false },
            { title: "Add Request Batching", description: "", priority: "architectural", completed: false },
            { title: "Optimize Subscriptions", description: "", priority: "architectural", completed: false },
            { title: "Implement Caching Layer", description: "", priority: "architectural", completed: false },
            { title: "Memory Management", description: "", priority: "architectural", completed: false },
            { title: "Optimize List Operations", description: "", priority: "architectural", completed: false },
            { title: "Add Rate Limiting", description: "", priority: "architectural", completed: false },
            { title: "Add Authorization Checks", description: "", priority: "architectural", completed: false },
            { title: "Validate Environment Variables", description: "", priority: "architectural", completed: false },
            { title: "Add Data Validation Layer", description: "", priority: "architectural", completed: false },
            { title: "Secure API Key Handling", description: "", priority: "architectural", completed: false },
            { title: "Add Input Sanitization (Security)", description: "", priority: "architectural", completed: false },
            { title: "Implement Error Recovery", description: "", priority: "architectural", completed: false },
            { title: "Add Error Boundary Recovery", description: "", priority: "architectural", completed: false },
            { title: "Improve Error Messages", description: "", priority: "architectural", completed: false },

            // 28 Missing Implementations
            { title: "Complete TimelineService", description: "", priority: "feature", completed: false },
            { title: "Implement Auth Store", description: "", priority: "feature", completed: false },
            { title: "Add Image Upload Service", description: "", priority: "feature", completed: false },
            { title: "Add Analytics Service", description: "", priority: "feature", completed: false },
            { title: "Add Caching Service", description: "", priority: "feature", completed: false },
            { title: "Add Retry Service", description: "", priority: "feature", completed: false },
            { title:G "Add Validation Service", description: "", priority: "feature", completed: false },
            { title: "Add ID Generator Utility", description: "", priority: "feature", completed: false },
            { title: "Email Verification Screen", description: "", priority: "feature", completed: false },
            { title: "Password Reset Screen", description: "", priority: "feature", completed: false },
            { title: "Loading Components", description: "", priority: "feature", completed: false },
            { title: "Error Recovery UI", description: "", priority: "feature", completed: false },
            { title: "Toast Queue Management", description: "", priority: "feature", completed: false },
            { title: "Offline Indicator", description: "", priority: "feature", completed: false },
            { title: "useAuth Hook", description: "", priority: "feature", completed: false },
            { title: "useProject Hook", description: "", priority: "feature", completed: false },
            { title: "useTimeline Hook", description: "", priority: "feature", completed: false },
            { title: "useOffline Hook", description: "", priority: "feature", completed: false },
            { title: "Offline Support", description: "", priority: "feature", completed: false },
            { title: "Project Deletion Logic", description: "", priority: "feature", completed: false },
            { title: "Portal Subcollection Init", description: "", priority: "feature", completed: false },
            { title: "Session Management", description: "", priority: "feature", completed: false },
            { title: "Account Deletion", description: "", priority: "feature", completed: false },
            { title: "Email Verification Flow", description: "", priority: "feature", completed: false },
            { title: "Environment Configuration", description: "", priority: "feature", completed: false },
            { title: "Feature Flags System", description: "", priority: "feature", completed: false },
            { title: "Monitoring Integration", description: "", priority: "feature", completed: false },
            { title: "Documentation System", description: "", priority: "feature", completed: false }
        ];

        // --- Core Functions ---

        /**
         * Initializes the Firebase app and authentication.
         */
        async function initFirebase() {
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.error("Firebase config is missing or invalid. Please paste your config from console.firebase.google.com");
                    loadingText.textContent = "Error: Firebase config is missing. Please edit the HTML file.";
                    loadingOverlay.classList.remove('hidden'); // Show the error
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable detailed Firestore logs

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        console.log("User signed in with UID:", userId);
                        
                        // Define the collection path based on the user
                        tasksCollectionRef = collection(db, `users/${userId}/tasks`);
                        
                        // 1. Run the one-time migration if needed
                        await migrateStaticTasks();
                        
                        // 2. Start listening for real-time task updates
                        listenForTasks();

                    } else {
                        // User is signed out
                        console.log("User is signed out.");
                        userId = null;
                        tasksCollectionRef = null;
                        // Sign in anonymously
                        console.log("Signing in anonymously...");
                        try {
                            await signInAnonymously(auth);
                        } catch (anonError) {
                            console.error("Anonymous sign-in failed:", anonError);
                            loadingText.textContent = "Error: Anonymous sign-in failed.";
                            loadingOverlay.classList.remove('hidden');
                        }
                    }
                });

                // Initial sign-in check
                if (!auth.currentUser) {
                    console.log("No user, signing in anonymously...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loadingText.textContent = `Error: ${error.message}`;
                loadingOverlay.classList.remove('hidden');
            }
        }

        /**
         * Checks if migration is needed and uploads static tasks on first run.
         */
        async function migrateStaticTasks() {
            // Use a generic migration key
            const migrationKey = `firebaseMigrationDone_public`;
            if (localStorage.getItem(migrationKey)) {
                console.log("Migration already completed.");
                return; // Migration already done
            }

            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = "Checking database...";

            try {
                // Check if the collection is empty
                const snapshot = await getDocs(tasksCollectionRef);
                if (snapshot.size > 0) {
                    console.log("Database already has data. Skipping migration.");
                    localStorage.setItem(migrationKey, 'true'); // Mark as done
                    loadingOverlay.classList.add('hidden');
                    return;
                }

                // Collection is empty, let's migrate
                console.log("Database is empty. Starting one-time task migration...");
                loadingText.textContent = "Migrating 106 tasks... (This happens once)";

                const batch = writeBatch(db);
                
                staticTasks.forEach(task => {
                    const newDocRef = doc(tasksCollectionRef); // Create a new doc with a random ID
                    batch.set(newDocRef, {
                        ...task,
                        createdAt: Timestamp.now() // Add a server timestamp
                    });
                });

                await batch.commit();
                console.log("Migration successful!");
                localStorage.setItem(migrationKey, 'true');
                loadingOverlay.classList.add('hidden');

            } catch (error) {
                console.error("Error during migration:", error);
                loadingText.textContent = `Migration Error: ${error.message}`;
                // Don't hide overlay on error, so user sees it
            }
        }

        /**
         * Sets up a real-time listener for tasks in Firestore.
         */
        function listenForTasks() {
            if (!tasksCollectionRef) return;

            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = "Syncing tasks...";

            onSnapshot(tasksCollectionRef, (snapshot) => {
                console.log("Received new snapshot from Firestore.");
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });

                // Sort tasks to show newest first (or by other criteria)
                tasks.sort((a, b) => {
                    const aTime = a.createdAt?.seconds || 0;
                    const bTime = b.createdAt?.seconds || 0;
                    return aTime - bTime; // Oldest first
                });

                renderTasks(tasks);
                loadingOverlay.classList.add('hidden');

            }, (error) => {
                console.error("Error listening for tasks:", error);
                loadingText.textContent = `Sync Error: ${error.message}`;
            });
        }

        /**
         * Renders the list of tasks to the DOM.
         */
        function renderTasks(tasks) {
            // Clear current lists
            criticalList.innerHTML = '';
            architecturalList.innerHTML = '';
            featureList.innerHTML = '';

            let completedCount = 0;
            
            tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                
                if (task.priority === 'critical') {
                    criticalList.appendChild(taskElement);
                } else if (task.priority === 'architectural') {
                    architecturalList.appendChild(taskElement);
                } else {
                    featureList.appendChild(taskElement);
                }

                if (task.completed) {
                    completedCount++;
                }
            });

            // Update progress bar
            const totalTasks = tasks.length;
            const percentage = totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${completedCount} / ${totalTasks} tasks completed`;
        }

        /**
         * Creates an HTML element for a single task.
         */
        function createTaskElement(task) {
            const li = document.createElement('li');
            li.className = 'task-item';
            
            // Sanitize content to prevent XSS
            const sanitizedTitle = document.createTextNode(task.title).textContent;
            const sanitizedDescription = document.createTextNode(task.description || '').textContent;

            li.innerHTML = `
                <div class="flex-1 min-w-0">
                    <div class="flex items-start">
                        <input id="${task.id}" data-id="${task.id}" type="checkbox" class="task-checkbox mr-3 flex-shrink-0 mt-1" ${task.completed ? 'checked' : ''}>
                        <label for="${task.id}" class="text-gray-200 cursor-pointer">
                            <span class="block font-medium">${sanitizedTitle}</span>
                            ${sanitizedDescription ? `<span class="block text-sm text-gray-400">${sanitizedDescription}</span>` : ''}
                        </label>
                    </div>
                </div>
                <button class="delete-button" data-id="${task.id}">Delete</button>
            `;
            return li;
        }

        /**
         * Handles the form submission to add a new task.
         */
        async function handleAddTask(e) {
            e.preventDefault();
            
            const title = taskTitleInput.value.trim();
            const description = taskDescriptionInput.value.trim();
            const priority = taskPriorityInput.value;

            if (!title) {
                // Use a custom modal/alert if available, otherwise fallback
                console.warn("Task title is required."); 
                // In a real app, show a toast or message. `alert` is blocked.
                taskTitleInput.focus();
                return;
            }

            try {
                // Add the new task to Firestore
                await addDoc(tasksCollectionRef, {
                    title,
                    description,
                    priority,
                    completed: false,
                    createdAt: Timestamp.now()
                });

                // Clear the form
                taskTitleInput.value = '';
                taskDescriptionInput.value = '';
                
            } catch (error) {
                console.error("Error adding task:", error);
                // Show user-friendly error
            }
        }

        /**
         * Handles clicks on checkboxes and delete buttons using event delegation.
         */
        function handleListClick(e) {
            const target = e.target;

            if (target.classList.contains('task-checkbox')) {
                // Checkbox was clicked
                const taskId = target.dataset.id;
                const isCompleted = target.checked;
                toggleTask(taskId, isCompleted);
            } else if (target.classList.contains('delete-button')) {
                // Delete button was clicked
                const taskId = target.dataset.id;
                
                // Simple confirmation - this might be blocked in iframe
                // A custom modal is preferred.
                console.log("Delete clicked for", taskId);
                // Since `confirm` is blocked, we'll just delete directly
                // if (confirm("Are you sure you want to delete this task?")) {
                //     deleteTask(taskId);
                // }
                // For this environment, we'll delete without confirmation
                // In a real app, you would build a custom modal.
                deleteTask(taskId);
            }
        }

        /**
         * Updates a task's 'completed' status in Firestore.
         */
        async function toggleTask(id, isCompleted) {
            if (!id || !tasksCollectionRef) return;
            const taskDocRef = doc(db, tasksCollectionRef.path, id);
            try {
                await updateDoc(taskDocRef, {
                    completed: isCompleted
                });
                console.log(`Task ${id} updated.`);
            } catch (error) {
                console.error("Error updating task:", error);
            }
        }

        /**
         * Deletes a task from Firestore.
         */
        async function deleteTask(id) {
            if (!id || !tasksCollectionRef) return;
            const taskDocRef = doc(db, tasksCollectionRef.path, id);
            try {
                await deleteDoc(taskDocRef);
                console.log(`Task ${id} deleted.`);
            } catch (error) {
                console.error("Error deleting task:", error);
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            addTaskForm.addEventListener('submit', handleAddTask);
            checklistContainer.addEventListener('click', handleListClick);
        });

    </script>

</body>
</html>

